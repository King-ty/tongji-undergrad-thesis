\section{引\ 言}\label{sec:introduction}

随着面向服务架构（SOA）的发展，微服务~\cite{lewis2014microservices}已经成为了一种日渐流行的架构风格，并得到了工业界的广泛采用（例如Netflix的视频点播服务~\cite{msnetflix}和Google的云存储服务~\cite{msgoogle}等）。与传统的单一服务（monolithic service）模式不同，微服务架构将一个庞大的服务拆分为多个独立的、简单的、解耦合的微服务，通过网络进行通信，每个微服务都可以独立部署、升级、扩展，因此可以突破传统软件架构的限制，极大地提升了软件开发的灵活性和效率。

% 微服务架构的典型应用场景包括：Netflix的视频点播服务~\cite{}、Amazon的电子商务服务~\cite{}、Uber的叫车服务~\cite{}等等。

但是，在提供了开发、部署等方面的灵活性和便利性的同时，微服务架构也带来了一些新的挑战，并引入了许多新的攻击面。

首先是运行平台的安全问题。微服务通常部署在公有云PaaS上，PaaS（平台即服务）\cite{mell2011nist}是一种云计算模型，提供了可用于开发、运行和管理应用程序的完整的云平台（包括硬件、软件和基础设施），并提供了自动化扩展的能力。然而，使用PaaS的微服务需要信任公有云，以保证其不会窃取用户的私密信息；如果公有云平台是恶意的或者被恶意攻击者劫持，很容易威胁到其上运行的微服务的安全性。因此，公有云限制了微服务的应用场景（如人脸数据处理等）。

另外，微服务节点间的通信也面临新的挑战。由于分布式、解耦合的特点，微服务节点之间需要频繁的通信，这在单一服务的基础上额外引入了通信攻击面，对微服务架构的通信安全和节点认证等方面提出了挑战。例如，微服务节点之间的通信可能会被窃听、篡改，从而导致数据泄露、数据篡改等问题；恶意的或被劫持的节点可能会骗取正常节点的信任，从而窃取正常节点的机密信息，造成隐私泄露。同时，大量微服务节点的多级通信关系也对通信的效率提出了挑战，研究表明，传统的单一服务只需要满足百毫秒级别的延迟要求即可对用户提供高质量的服务，而微服务场景下节点间的通信需要满足亚毫秒（sub-ms）的要求，才能在总体延迟上达到和单一服务相近的效果~\cite{sriraman2018mutune}。

因此，为了保障安全计算场景下微服务的安全性（security），我们需要从运行时环境和网络通信两方面入手，二者缺一不可；例如如果只保护了运行时数据安全，但是网络通信遭到了攻击，仍然会威胁整个服务平台的机密性和完整性，反之亦然。

为了保障微服务运行时的安全，我们可以借助可信执行环境（TEE）~\cite{sabt2015trusted}的力量。可信执行环境是一种硬件级别的安全内存，通过CPU创建安全的飞地（Enclave），可以对运行在其内部的代码、数据提供机密性、完整性的支持，从而保护微服务应用的安全。因为可信执行环境结合了密码学原理和硬件级别的保护，可以在不信任公有云系统的情况下保护数据的机密性和完整性，即使云上系统是恶意的或被劫持，也能保护飞地中的数据。另外，因为有些TEE的内存不能过大，且为了减少攻击面，需要控制可信信任基（TCB）的大小，这与微服务独立而微小的特点是天然符合的。

目前主流的公有云大多是Intel架构的，因此我们选择使用Intel SGX~\cite{costan2016intel}来提供保护；但是由于SGX主要提供的是硬件级别的隔离，只包含基本的库函数而不能提供POSIX接口，不能直接移植现有的程序，因此我们需要在SGX的基础上针对微服务的特点设计合适的运行时系统，以支持微服务的运行。

目前SGX上的运行环境主要有两种设计思路。第一种从系统角度出发，在SGX中运行一个小型的操作系统，比如LibOS（例如Graphene-SGX~\cite{tsai2017graphene}），这样可以在无改动或极少改动的情况下将现有程序运行在SGX中；但是这样会包含较多的代码，具有较大的TCB，可能存在较多漏洞和较大的攻击面。第二种思路是从编译器角度出发，对特定编程语言实现SGX内的运行接口（例如Rust-SGX~\cite{wang2019towards}、GoTEE~\cite{ghosn2019secured}等），这样可以达到很小的TCB；但是这种方式只能针对特定的编程语言，且不能实现所有的系统功能。在本课题中，根据微服务应用的特点，我们设计了一种将二者结合的细粒度、模块化的运行时实现方式，能够在较小TCB的情况下为应用提供SGX的保护。

为了保障微服务节点通信的安全，我们需要安全高效的远程验证协议和通信协议。根据文献综述~\cite{Vale2021SecurityIM,Berardi2022MicroserviceSA}，在微服务场景下的网络通信需要提供4层保障，分别是用户端和服务端的验证、微服务节点间互相验证对方的身份和合法性、微服务节点间通信的机密性和完整性保障、依赖节点间授权合法性的验证。其中，第一种情况是SOA架构固有的问题而不是微服务架构新引入的问题，关于这个问题的解决已有成熟的方案（例如OAuth2~\cite{oauth2spec}等），因此本次研究可以不考虑；第二种情况要确认对方身份合法并且运行在一个符合规范的SGX实体中，这一点可以通过Intel的SGX远程验证~\cite{intel-sgx-ra}进行；第三种情况主要面对的是网络上的攻击，例如中间人攻击（MITM）和重放攻击（Replay Attack）等，也已经有了较成熟的解决方案（例如TLS协议~\cite{8446}）；最后一种情况是应用开发者的职责，需要进行细粒度的授权划分，可以使用基于Token交换的授权方案~\cite{rfc8693}。本次设计针对微服务安全计算的场景，将TLS、SGX远程验证和Token交换结合起来，设计了一种新的安全高效的安全通信协议。
% 在通信性能方面，我们参考了几种常见远程过程调用（RPC）框架（例如gRPC~\cite{}、Thrift~\cite{}等）的性能，以及RPC与HTTP协议的性能的对比~\cite{}，选择使用高效的gRPC来进行微服务节点间的通信。

另外，为了减小TCB，我们难以使用运行时内存占用较大的语言（例如脚本语言）编写微服务节点，而需要使用系统编程语言（例如C~\cite{kernighan1988c}、C++~\cite{stroustrup2013cpp}、Rust~\cite{rust-lang}等）。由于需要高安全性保障的微服务节点通常是处理敏感数据或涉及到敏感业务的，在所有节点中占据比重较低，因此这种对于编程语言的限制是合理的。然而，尽管可以通过非技术手段保障节点不是恶意的，但是我们不能保证使用系统语言编程的微服务节点不会出现漏洞（例如缓冲区溢出、悬垂指针等），这些问题会严重危害系统的稳定性，同时也会增大攻击面，例如缓冲区溢出攻击等。为了减少这些问题，我们选择使用安全编程语言（即Rust）编写平台和微服务节点，进一步提高平台的内存安全。

为了对平台进行评估，我们需要使用Rust语言编写的微服务应用进行测试。然而目前还没有使用Rust语言编写的开源微服务应用，已有的其他语言实现的微服务基准（例如DeathStarBench~\cite{gan2019open}和$\mu$Suite~\cite{sriraman2018mu}等）难以用Rust重写，且不是很符合安全计算的场景特点。因此，我们用Rust结合gRPC构建了一个简单的图像处理相关的微服务示例程序。

我们用这个示例程序对平台进行了测试，发现通信延迟比SGX外运行的微服务程序高14.3\%左右，我们认为为了达到安全性的要求，这个性能损失是可以接受的；但是计算延迟约是SGX外的6.01倍，因此仍需后续工作进一步优化。
% DONE：计算测试得出的真实数据并修改
% \footnote{已开源，链接：XXX}

\textbf{贡献}\ 本文的主要贡献如下：
\begin{itemize}
    \item 结合微服务计算的特点，设计实现了细粒度、模块化的运行时系统。
    \item 结合现有的成熟的解决方案，设计实现了安全高效的微服务通信协议。
    \item 设计并实现了一个Rust语言的简单的图像处理的微服务示例程序。
\end{itemize}

本文后续章节的安排如下：\cref{sec:background}介绍背景知识；\cref{sec:overview}介绍威胁模型和各部分设计；\cref{sec:implimentation}介绍平台的实现；\cref{sec:evaluation}介绍平台的评估；\cref{sec:discussion}是相关工作和展望；\cref{sec:conclusion}是总结。

%内部运行一个完整的操作系统，如Graphene~\cite{}、SCONE~\cite{}等；第二种是在SGX内部运行一个轻量级的运行时系统，如Occlum~\cite{}、Graphene-SGX~\cite{}等。第一种设计思路的优点是可以直接运行现有的应用程序，但是由于操作系统的复杂性，其本身的代码量较大，因此需要信任较多的代码，同时由于操作系统的复杂性，其本身的安全性也难以保证。第二种设计思路的优点是可以在SGX内部运行一个轻量级的运行时系统，因此可以大大减少运行时系统的代码量，从而减少信任的代码量，同时也可以提高运行时系统的安全性。但是，由于SGX的特性，其内部的运行时系统只能运行在SGX的受保护内存中，因此无法直接运行现有的应用程序，需要对应用程序进行修改，从而增加了开发的成本。

% 平台即服务（PaaS）是一种云计算范式，可以降低公有云用户开发应用的成本。其中，为提高云服务的可用性和降低维护成本，微服务（MicroService）将一个庞大服务（monolithic service）通过独立的微型服务的组合来实现；而微型服务间通过远端过程调用（RPC）进行通信。然而，使用公有云的微服务需要信任公有云，以保证其不会窃取用户的私密信息，极大地限制了公有云微服务的使用场景（如人脸数据处理等）。
% 可信执行环境（如SGX和TrustZone）可以对运行在可信执行环境的的数据、代码提供机密性、完整性的支持。因此，可信执行环境可以适用于微服务来保护处理敏感数据的微服务。
% 然而，尽管微服务计算可以降低开发的成本，微服务计算本身带来的信任问题为其实现带来了很大的挑战。首先，云应用程序需要与大量的系统组件一起运行，具有较大的TCB。然而由于其本身较大的代码量与较高的复杂性，他们很可能具有较大的漏洞，而这会被攻击者利用并带来内存安全上的挑战；另一方面，云服务商本身是不可信的，运行在其上的恶意程序可能会读取、篡改用户运行时数据，或对微服务间的通信进行篡改。这些都对对微服务本身的机密性和完整性提出挑战。
% 本课题旨在开发一个基于可信执行环境的安全高效微服务计算平台。首先本课题需要基于现有的微服务计算本身的特点，设计细粒度、模块化的运行时系统来减少TCB；其次本课题需要设计针对微服务计算的远程验证协议；最后本课题需要将其高性能地实现在可信执行环境中并测量不同微服务的性能。

% 1）需要基于微服务计算本身的特点，设计细粒度、模块化的运行时
% 2）需要实现针对微服务计算的远程验证协议
% 3）在TEE环境上将系统正确地实现，并测量不同微服务的性能
